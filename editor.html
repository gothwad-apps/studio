<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gothwad Editor</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ext-language_tools.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- ðŸŽ¨ MODERN MOBILE THEME --- */
        :root { --primary: #6200ea; --bg-color: #ffffff; --border-color: #eeeeee; --text-main: #333333; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; padding: 0; height: 100vh; width: 100vw; display: flex; flex-direction: column; background-color: var(--bg-color); font-family: 'Segoe UI', Roboto, sans-serif; overflow: hidden; }

        /* HEADER */
        .ide-header { height: 60px; background: #ffffff; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 10px rgba(0,0,0,0.02); z-index: 20; flex-shrink: 0; }
        .header-left { display: flex; align-items: center; gap: 8px; flex: 1; overflow: hidden; }
        .back-btn { font-size: 20px; color: #555; padding: 5px; cursor: pointer; flex-shrink: 0; }
        .file-info { display: flex; flex-direction: column; overflow: hidden; }
        .file-name { font-size: 15px; font-weight: 700; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .project-name { font-size: 10px; color: #888; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .header-right { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
        
        .status-badge { font-size: 9px; font-weight: 600; color: #ccc; margin-right: 2px; }
        .status-badge.saved { color: #00c853; }
        .status-badge.unsaved { color: #ff9100; }

        .icon-btn { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; border: none; cursor: pointer; background: #f5f5f5; color: #555; transition: 0.1s; }
        .icon-btn:active { transform: scale(0.95); background: #eee; }
        .btn-run { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .btn-undo { background: #fff; border: 1px solid #eee; color: #444; }

        /* EDITOR */
        #editor-wrapper { flex: 1; position: relative; background: #fff; }
        #editor { position: absolute; top: 0; right: 0; bottom: 0; left: 0; font-size: 15px !important; line-height: 24px !important; }

        /* KEYBOARD */
        .quick-keys-bar { height: 50px; background: #fff; border-top: 1px solid var(--border-color); display: flex; align-items: center; gap: 8px; padding: 0 10px; overflow-x: auto; white-space: nowrap; flex-shrink: 0; -ms-overflow-style: none; scrollbar-width: none; }
        .quick-keys-bar::-webkit-scrollbar { display: none; }
        .key-chip { min-width: 45px; height: 36px; background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; color: #333; font-weight: 600; font-family: monospace; font-size: 16px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 0 #ddd; }
        .key-chip:active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: none; transform: translateY(2px); }
        .key-chip-text { font-size: 12px; font-family: sans-serif; width: auto; padding: 0 10px; }

        /* MENU */
        .dropdown-menu { position: absolute; top: 65px; right: 10px; background: #fff; width: 200px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid #eee; display: none; flex-direction: column; z-index: 100; }
        .menu-item { padding: 15px; font-size: 14px; color: #333; font-weight: 500; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f9f9f9; cursor: pointer; }
        .menu-item:active { background: #f5f5f5; }
        .text-danger { color: #d32f2f; }

        /* LOADER */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 200; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 15px; }
        .loader-spinner { font-size: 30px; color: var(--primary); }
    </style>
</head>
<body>

    <div id="loader">
        <i class="fas fa-circle-notch fa-spin loader-spinner"></i>
        <div style="font-size:14px; color:#666; font-weight:500;">Loading File...</div>
    </div>

    <header class="ide-header">
        <div class="header-left">
            <i class="fas fa-arrow-left back-btn" onclick="window.history.back()"></i>
            <div class="file-info">
                <div class="file-name" id="display-filename">loading...</div>
                <div class="project-name" id="display-projectname">Project</div>
            </div>
        </div>
        <div class="header-right">
            <button class="icon-btn btn-undo" onclick="undoCode()"><i class="fas fa-undo"></i></button>
            <button class="icon-btn btn-undo" onclick="redoCode()"><i class="fas fa-redo"></i></button>
            <span class="status-badge" id="save-status">Saved</span>
            <button class="icon-btn btn-run" onclick="runCode()"><i class="fas fa-play"></i></button>
            <button class="icon-btn btn-more" onclick="toggleMenu()"><i class="fas fa-ellipsis-v"></i></button>
        </div>
    </header>

    <div class="dropdown-menu" id="main-menu">
        <div class="menu-item" onclick="formatCode()"><i class="fas fa-align-left"></i> Format Code</div>
        <div class="menu-item" onclick="copyAll()"><i class="fas fa-copy"></i> Copy All</div>
        <div class="menu-item text-danger" onclick="clearCode()"><i class="fas fa-trash"></i> Clear All</div>
    </div>

    <div id="editor-wrapper"><div id="editor"></div></div>

    <div class="quick-keys-bar">
        <div class="key-chip" onclick="ins('<')">&lt;</div>
        <div class="key-chip" onclick="ins('>')">&gt;</div>
        <div class="key-chip" onclick="ins('/')">/</div>
        <div class="key-chip" onclick="ins('=')">=</div>
        <div class="key-chip" onclick="ins('(')">(</div>
        <div class="key-chip" onclick="ins(')')">)</div>
        <div class="key-chip" onclick="ins('{')">{</div>
        <div class="key-chip" onclick="ins('}')">}</div>
        <div class="key-chip" onclick="ins(';')">;</div>
        <div class="key-chip" onclick="ins('"')">"</div>
        <div class="key-chip" onclick="ins('$')">$</div>
        <div class="key-chip" onclick="ins('!')">!</div>
        <div class="key-chip key-chip-text" onclick="ins('class')">class</div>
        <div class="key-chip key-chip-text" onclick="ins('function')">func</div>
        <div class="key-chip key-chip-text" onclick="ins('console.log')">log</div>
    </div>

    <script type="module">
        import { auth, db, doc, getDoc, updateDoc } from './firebase-config.js';

        // 1. ROBUST SETUP
        const params = new URLSearchParams(window.location.search);
        const projectId = params.get('id');
        // Decode URI component fixes issues with filenames having spaces
        const fileNameParam = decodeURIComponent(params.get('name') || '');
        const fileType = params.get('tab') || 'html';

        let displayFile = fileNameParam || 'index.html';
        if(!fileNameParam) {
            if(fileType === 'css') displayFile = 'style.css';
            if(fileType === 'js') displayFile = 'script.js';
        }
        
        document.getElementById('display-filename').innerText = displayFile;

        // 2. ACE EDITOR CONFIG
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/textmate");
        
        let aceMode = 'html';
        if (displayFile.endsWith('.css')) aceMode = 'css';
        else if (displayFile.endsWith('.js')) aceMode = 'javascript';
        else if (displayFile.endsWith('.json')) aceMode = 'json';
        else if (displayFile.endsWith('.py')) aceMode = 'python';
        
        editor.session.setMode("ace/mode/" + aceMode);
        editor.setOptions({ fontSize: "15px", showPrintMargin: false, wrap: true, showFoldWidgets: false, fixedWidthGutter: true, displayIndentGuides: false, fontFamily: "Menlo, Monaco, Consolas, 'Courier New', monospace" });
        editor.renderer.setPadding(10); 
        
        window.undoCode = () => { editor.undo(); editor.focus(); };
        window.redoCode = () => { editor.redo(); editor.focus(); };

        let fullProjectData = {};
        let saveTimer = null;
        const statusBadge = document.getElementById('save-status');

        // 3. LOAD CONTENT (THE FIX)
        async function init() {
            if(!projectId) return;
            
            // Check Local Cache First (Instant Load)
            const cached = localStorage.getItem(`proj_cache_${projectId}`);
            if(cached) {
                const data = JSON.parse(cached);
                attemptLoadContent(data);
                document.getElementById('loader').style.display = 'none';
            }

            // Cloud Backup Load
            try {
                const docRef = doc(db, "projects", projectId);
                const snap = await getDoc(docRef);
                if(snap.exists()) {
                    fullProjectData = snap.data();
                    document.getElementById('display-projectname').innerText = fullProjectData.name;
                    attemptLoadContent(fullProjectData);
                    document.getElementById('loader').style.display = 'none';
                }
            } catch(e) { console.log("Offline mode"); }
        }
        init();

        function attemptLoadContent(data) {
            let content = null;

            // Priority 1: Check Local Storage (Imported files live here)
            // This is the key generated by FileManager when importing
            let importKey = `proj_${projectId}_${displayFile}`;
            let importContent = localStorage.getItem(importKey);

            // Priority 2: Check standard editor save key
            let editKey = `file_content_${projectId}_${displayFile}`;
            let editContent = localStorage.getItem(editKey);

            // Priority 3: Cloud Data
            let cloudContent = null;
            if (displayFile === 'index.html') cloudContent = data.html;
            else if (displayFile === 'style.css') cloudContent = data.css;
            else if (displayFile === 'script.js') cloudContent = data.js;
            
            // Determine best source
            if(editContent !== null) content = editContent;
            else if(importContent !== null) content = importContent; // <--- FIX FOR IMPORTED FILES
            else if(cloudContent !== null) content = cloudContent;

            // If still null, try finding in extraFiles array
            if(content === null && data.extraFiles) {
                // Sometimes extraFiles stores content directly (future proofing)
                const found = data.extraFiles.find(f => f.name === displayFile);
                if(found && found.content) content = found.content;
            }

            // Set to Editor
            if(content !== null) {
                // Only set if editor is basically empty (avoid overwriting user work if multiple calls)
                if(editor.getValue().length < 2) { 
                    editor.setValue(content, -1);
                    editor.getSession().getUndoManager().reset();
                }
            } else {
                console.log("New file or Empty");
            }
        }

        // 4. AUTO SAVE (Writes to both keys to be safe)
        editor.session.on('change', () => {
            statusBadge.innerText = "â€¢";
            statusBadge.className = "status-badge unsaved";
            if(saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(saveProject, 800);
        });

        async function saveProject() {
            const code = editor.getValue();
            
            // SAVE TO LOCAL STORAGE (Both Import Key and Edit Key)
            // This ensures FileManager can read it back if it uses that key
            localStorage.setItem(`proj_${projectId}_${displayFile}`, code); 
            localStorage.setItem(`file_content_${projectId}_${displayFile}`, code);

            // Update Memory Object
            if (displayFile === 'index.html') fullProjectData.html = code;
            else if (displayFile === 'style.css') fullProjectData.css = code;
            else if (displayFile === 'script.js') fullProjectData.js = code;
            
            localStorage.setItem(`proj_cache_${projectId}`, JSON.stringify(fullProjectData));

            // Sync Cloud
            try {
                const docRef = doc(db, "projects", projectId);
                let updateData = {};
                
                if (displayFile === 'index.html') updateData.html = code;
                else if (displayFile === 'style.css') updateData.css = code;
                else if (displayFile === 'script.js') updateData.js = code;
                // For other files, we just rely on local storage + extraFiles list in DB for now
                
                await updateDoc(docRef, updateData);
                statusBadge.innerText = "Saved";
                statusBadge.className = "status-badge saved";
            } catch(e) {
                statusBadge.innerText = "Local";
            }
        }

        // 5. HELPERS
        window.ins = (txt) => { editor.insert(txt); editor.focus(); };
        window.runCode = async () => { await saveProject(); window.location.href = `preview.html?id=${projectId}`; };
        window.toggleMenu = () => { const m = document.getElementById('main-menu'); m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; };
        document.addEventListener('click', (e) => { if (!e.target.closest('.icon-btn') && !e.target.closest('.dropdown-menu')) document.getElementById('main-menu').style.display = 'none'; });
        window.copyAll = () => { navigator.clipboard.writeText(editor.getValue()); toggleMenu(); alert("Copied!"); };
        window.clearCode = () => { if(confirm("Clear everything?")) editor.setValue(""); toggleMenu(); };
        window.formatCode = () => { editor.selectAll(); toggleMenu(); };

    </script>
</body>
</html>
