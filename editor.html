<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Editor</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ext-language_tools.js"></script>

    <style>
        /* --- WHITE THEME EDITOR --- */
        body {
            background-color: #ffffff;
            margin: 0; padding: 0;
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            user-select: none; /* UI select disable, Editor handles text */
        }

        /* 1. HEADER */
        .ide-header {
            height: 55px; background: #f8f9fa;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; border-bottom: 1px solid #ddd;
            z-index: 10;
        }

        .file-info { display: flex; align-items: center; gap: 10px; }
        .back-icon { font-size: 18px; color: #555; padding: 10px; cursor: pointer; }

        .file-name { font-size: 16px; font-weight: 700; color: #333; }
        .project-sub { font-size: 10px; color: #666; display: block; margin-top: -2px; }

        .ide-actions { display: flex; gap: 8px; align-items: center; position: relative; }
        
        .save-status { font-size: 10px; color: #888; font-weight: 500; min-width: 35px; text-align: right; }

        /* Buttons */
        .btn-action {
            width: 35px; height: 35px; border-radius: 50%; border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 14px; transition: 0.2s;
            background: #fff; border: 1px solid #ddd; color: #333;
        }
        .btn-run { background: #e8f5e9; color: #2e7d32; border-color: #c8e6c9; }
        .btn-action:active { background: #eee; }

        /* 2. EDITOR AREA */
        #editor-container { flex: 1; position: relative; background: #fff; }
        #editor { position: absolute; top: 0; right: 0; bottom: 0; left: 0; font-size: 14px; line-height: 22px; }

        /* 3. KEYBOARD HELPER */
        .quick-keys {
            height: 45px; background: #f1f1f1;
            display: flex; align-items: center; gap: 5px;
            padding: 0 8px; overflow-x: auto;
            border-top: 1px solid #ddd;
        }
        .key-btn {
            min-width: 40px; height: 35px;
            background: #fff; border: 1px solid #ccc; color: #333;
            border-radius: 6px; font-family: monospace; font-size: 16px;
            cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .key-btn:active { background: var(--primary); color: #fff; }

        /* --- MENUS --- */
        
        /* Top Right Menu */
        .dropdown-menu {
            position: absolute; top: 45px; right: 0;
            background: #fff; width: 160px;
            border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            border: 1px solid #eee; display: none; flex-direction: column; z-index: 100;
        }
        .menu-item { padding: 12px 15px; font-size: 14px; color: #333; cursor: pointer; border-bottom: 1px solid #f5f5f5; }
        .menu-item:last-child { border-bottom: none; }
        .menu-item:active { background: #f5f5f5; }
        .menu-danger { color: #d32f2f; }

        /* Context Menu (Copy/Paste) */
        #context-menu {
            position: absolute; background: #333; color: #fff;
            border-radius: 8px; padding: 5px; display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 999;
            flex-direction: row; gap: 10px;
        }
        .ctx-btn {
            background: transparent; border: none; color: #fff;
            padding: 8px 12px; font-size: 13px; font-weight: 600; cursor: pointer;
        }
        .ctx-btn:active { color: #aaa; }
        .ctx-divider { width: 1px; background: #555; height: 20px; align-self: center; }

        /* Loader */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 200; display: flex;
            align-items: center; justify-content: center; color: #333;
            flex-direction: column; gap: 10px;
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <i class="fas fa-circle-notch fa-spin" style="font-size:30px; color:#6200ee"></i>
        <span style="font-size:12px;">Opening File...</span>
    </div>

    <div class="ide-header">
        <div class="file-info">
            <i class="fas fa-arrow-left back-icon" onclick="window.location.href='filemanager.html?id=' + projectId"></i>
            <div>
                <div class="file-name" id="display-filename">...</div>
                <div class="project-sub" id="display-projectname">Project</div>
            </div>
        </div>
        <div class="ide-actions">
            <span class="save-status" id="saveStatus">Synced</span>
            <button class="btn-action btn-run" onclick="runCode()"><i class="fas fa-play"></i></button>
            <button class="btn-action" onclick="toggleMenu()"><i class="fas fa-ellipsis-v"></i></button>
            
            <div class="dropdown-menu" id="topMenu">
                <div class="menu-item" onclick="renameFile()">Rename File</div>
                <div class="menu-item" onclick="copyAll()">Copy All Code</div>
                <div class="menu-item" onclick="formatCode()">Format Code</div>
                <div class="menu-item menu-danger" onclick="clearCode()">Clear Content</div>
            </div>
        </div>
    </div>

    <div id="editor-container">
        <div id="editor"></div>
    </div>

    <div id="context-menu">
        <button class="ctx-btn" onclick="execCmd('selectAll')">Select All</button>
        <div class="ctx-divider"></div>
        <button class="ctx-btn" onclick="execCmd('copy')">Copy</button>
        <div class="ctx-divider"></div>
        <button class="ctx-btn" onclick="execCmd('paste')">Paste</button>
    </div>

    <div class="quick-keys">
        <button class="key-btn" onclick="insertKey('<')">&lt;</button>
        <button class="key-btn" onclick="insertKey('>')">&gt;</button>
        <button class="key-btn" onclick="insertKey('/')">/</button>
        <button class="key-btn" onclick="insertKey('=')">=</button>
        <button class="key-btn" onclick="insertKey('"')">"</button>
        <button class="key-btn" onclick="insertKey('{')">{</button>
        <button class="key-btn" onclick="insertKey('}')">}</button>
        <button class="key-btn" onclick="insertKey(';')">;</button>
        <button class="key-btn" onclick="insertKey('!')">!</button>
        <button class="key-btn" onclick="insertKey('class')">class</button>
        <button class="key-btn" onclick="insertKey('id')">id</button>
    </div>

    <script type="module">
        import { auth, db, doc, getDoc, updateDoc } from './firebase-config.js';

        // 1. SETUP & PARAMS
        const params = new URLSearchParams(window.location.search);
        window.projectId = params.get('id'); // Global for back button
        const fileType = params.get('tab') || 'html';
        const fileNames = { 'html': 'index.html', 'css': 'style.css', 'js': 'script.js' };

        // 2. ACE EDITOR CONFIG
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/chrome"); // Clean White Theme
        
        let aceMode = 'html';
        if(fileType === 'css') aceMode = 'css';
        if(fileType === 'js') aceMode = 'javascript';
        editor.session.setMode("ace/mode/" + aceMode);

        editor.setFontSize(14);
        editor.setShowPrintMargin(false);
        
        // --- ðŸ”¥ MAGIC FOR THIN GUTTER ---
        editor.setOption("showFoldWidgets", false); // Hides collapse arrows (saves space)
        editor.renderer.setPadding(0); // Removes padding
        editor.setOption("fixedWidthGutter", true); // Optional: forces width
        
        editor.setOptions({
            enableBasicAutocompletion: true,
            enableLiveAutocompletion: true,
            showLineNumbers: true,
            tabSize: 2
        });

        // UI Updates
        document.getElementById('display-filename').innerText = fileNames[fileType];
        
        let saveTimer = null;
        const statusSpan = document.getElementById('saveStatus');
        const loader = document.getElementById('loading-overlay');
        let fullProjectData = {};

        // 3. LOAD DATA
        async function init() {
            if(!projectId) return alert("Error: No ID");

            auth.onAuthStateChanged(async (user) => {
                if(!user) return window.location.href = 'login.html';

                try {
                    const docRef = doc(db, "projects", projectId);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        fullProjectData = docSnap.data();
                        document.getElementById('display-projectname').innerText = fullProjectData.name;

                        let content = "";
                        if(fileType === 'html') content = fullProjectData.html || "";
                        if(fileType === 'css') content = fullProjectData.css || "";
                        if(fileType === 'js') content = fullProjectData.js || "";

                        editor.setValue(content, -1);
                        loader.style.display = 'none';
                    } else {
                        alert("File not found!");
                        window.location.href = 'home.html';
                    }
                } catch(e) {
                    console.error(e);
                }
            });
        }
        init();

        // 4. AUTO SAVE
        editor.session.on('change', function() {
            statusSpan.innerText = "Typing...";
            if(saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(saveToCloud, 1500); 
        });

        async function saveToCloud() {
            statusSpan.innerText = "Saving...";
            let newContent = editor.getValue();
            let updatePayload = {};

            if(fileType === 'html') { updatePayload.html = newContent; fullProjectData.html = newContent; }
            if(fileType === 'css') { updatePayload.css = newContent; fullProjectData.css = newContent; }
            if(fileType === 'js') { updatePayload.js = newContent; fullProjectData.js = newContent; }
            
            updatePayload.updatedAt = new Date();

            try {
                const docRef = doc(db, "projects", projectId);
                await updateDoc(docRef, updatePayload);
                statusSpan.innerText = "Saved";
                statusSpan.style.color = "#2e7d32";
                setTimeout(() => { statusSpan.style.color = "#888"; }, 2000);
            } catch(e) {
                statusSpan.innerText = "Error";
                statusSpan.style.color = "red";
            }
        }

        // --- 5. LONG PRESS CONTEXT MENU LOGIC ---
        const contextMenu = document.getElementById('context-menu');
        
        // Disable default right-click
        document.getElementById('editor').addEventListener('contextmenu', function(e) {
            e.preventDefault();
            // Show custom menu at click position
            contextMenu.style.display = 'flex';
            
            // Adjust position to not go off screen
            let x = e.pageX;
            let y = e.pageY;
            if(x + 200 > window.innerWidth) x = window.innerWidth - 210;
            
            contextMenu.style.left = x + 'px';
            contextMenu.style.top = y + 'px';
        });

        // Hide menus on click elsewhere
        document.addEventListener('click', (e) => {
            if(!e.target.closest('#context-menu')) contextMenu.style.display = 'none';
            if(!e.target.closest('.ide-actions')) document.getElementById('topMenu').style.display = 'none';
        });

        window.execCmd = async (cmd) => {
            if(cmd === 'selectAll') {
                editor.selectAll();
            } else if(cmd === 'copy') {
                let text = editor.getCopyText();
                if(text) {
                    await navigator.clipboard.writeText(text);
                    alert("Copied to clipboard!");
                } else {
                    // Fallback: Copy All if nothing selected
                    await navigator.clipboard.writeText(editor.getValue());
                    alert("All code copied!");
                }
            } else if(cmd === 'paste') {
                try {
                    const text = await navigator.clipboard.readText();
                    editor.insert(text);
                } catch(err) {
                    alert("Paste permission denied. Use keyboard.");
                }
            }
            contextMenu.style.display = 'none';
        }

        // --- 6. TOP MENU ACTIONS ---
        window.toggleMenu = () => {
            const m = document.getElementById('topMenu');
            m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
        }

        window.renameFile = () => {
            alert("Renaming structural files (index/style/script) is disabled in this version to prevent crash.");
        }

        window.copyAll = async () => {
            await navigator.clipboard.writeText(editor.getValue());
            alert("All code copied!");
            toggleMenu();
        }

        window.formatCode = () => {
            // Basic beautify via JSON stringify hack (or just indent)
            // Ideally use a library, but for now just Select All
            editor.selectAll();
            alert("Auto-format requires plugin. Selected all for manual format.");
            toggleMenu();
        }

        window.clearCode = () => {
            if(confirm("Are you sure you want to delete all code?")) {
                editor.setValue("");
                saveToCloud();
            }
            toggleMenu();
        }

        window.runCode = async () => {
            await saveToCloud();
            window.location.href = `preview.html?id=${projectId}`;
        };

        window.insertKey = (k) => { editor.insert(k); editor.focus(); };

    </script>
</body>
</html>
