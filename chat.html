<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Direct Messages - GX Studio</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- LAYOUT --- */
        body {
            background-color: var(--bg-color);
            margin: 0; padding: 0;
            padding-top: 60px; /* Header */
            padding-bottom: 70px; /* Nav */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow-x: hidden;
        }

        /* HEADER */
        .app-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background: var(--surface-color);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            border-bottom: 1px solid var(--border);
        }
        .page-title { font-size: 18px; font-weight: 800; color: var(--primary); }
        .icon-btn { background: none; border: none; font-size: 18px; color: var(--text-main); cursor: pointer; }

        /* SEARCH */
        .search-container {
            padding: 15px;
            background: var(--surface-color);
            border-bottom: 1px solid var(--border);
        }
        .search-bar {
            width: 100%; padding: 10px 15px; border-radius: 20px;
            border: 1px solid var(--border); background: var(--bg-color);
            color: var(--text-main); font-size: 14px; outline: none;
        }

        /* USER LIST */
        .user-list {
            padding: 10px;
        }

        .user-card {
            background: var(--surface-color);
            padding: 12px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            border: 1px solid var(--border);
            transition: transform 0.1s;
            cursor: pointer;
        }
        .user-card:active { transform: scale(0.98); background-color: rgba(0,0,0,0.02); }

        .avatar {
            width: 45px; height: 45px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #555;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; font-weight: bold;
            margin-right: 15px;
        }

        .user-info { flex: 1; }
        .user-name { font-size: 15px; font-weight: 600; color: var(--text-main); margin-bottom: 2px; }
        .user-email { font-size: 12px; color: var(--text-sub); }
        
        .chat-icon { color: var(--primary); font-size: 18px; padding: 10px; }

        /* LOADING */
        .loading { text-align: center; margin-top: 50px; color: var(--text-sub); font-size: 14px; }

        /* NAV */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
            background: var(--surface-color);
            display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid var(--border); z-index: 95;
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-sub); text-decoration: none; height: 100%;
        }
        .nav-item i { font-size: 20px; margin-bottom: 4px; }
        .nav-item span { font-size: 10px; font-weight: 500; }
        .nav-item.active { color: var(--primary); }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="app-bar">
        <div class="page-title">Direct Messages</div>
        <button class="icon-btn" onclick="loadUsers()"><i class="fas fa-sync-alt"></i></button>
    </header>

    <!-- SEARCH -->
    <div class="search-container">
        <input type="text" id="searchInput" class="search-bar" placeholder="Search developer by name..." onkeyup="filterUsers()">
    </div>

    <!-- USERS LIST -->
    <div class="user-list" id="userList">
        <div class="loading"><i class="fas fa-circle-notch fa-spin"></i> Finding developers...</div>
    </div>

    <!-- BOTTOM NAV -->
    <nav class="bottom-nav">
        <a href="home.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="explore.html" class="nav-item">
            <i class="fas fa-compass"></i>
            <span>Explore</span>
        </a>
        <a href="globalchat.html" class="nav-item">
            <i class="fas fa-users"></i>
            <span>Global</span>
        </a>
        <a href="#" class="nav-item active"> <!-- Active -->
            <i class="fas fa-comment-dots"></i>
            <span>DM</span>
        </a>
        <a href="aichat.html" class="nav-item">
            <i class="fas fa-robot"></i>
            <span>AI</span>
        </a>
    </nav>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { auth, db, collection, getDocs, setDoc, doc, serverTimestamp } from './firebase-config.js';

        const list = document.getElementById('userList');
        let currentUser = null;
        let allUsers = [];

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                // 1. Khud ko list me add karo (Taaki dusre tumhe dekh sake)
                await registerSelf(user);
                // 2. Baaki logo ko load karo
                loadUsers();
            } else {
                window.location.href = 'login.html';
            }
        });

        // --- 1. Register Self in 'users' collection ---
        async function registerSelf(user) {
            try {
                let name = user.displayName;
                if(!name && user.email) name = user.email.split('@')[0];
                
                // Users collection me data update karo
                await setDoc(doc(db, "users", user.uid), {
                    name: name,
                    email: user.email,
                    lastActive: serverTimestamp(),
                    uid: user.uid
                }, { merge: true });
            } catch(e) {
                console.error("Directory Error:", e);
            }
        }

        // --- 2. Load All Users ---
        window.loadUsers = async function() {
            try {
                const querySnapshot = await getDocs(collection(db, "users"));
                allUsers = [];
                
                querySnapshot.forEach((doc) => {
                    let data = doc.data();
                    // Khud ko list me mat dikhao
                    if (data.uid !== currentUser.uid) {
                        allUsers.push(data);
                    }
                });

                renderUsers(allUsers);
            } catch (e) {
                console.error(e);
                list.innerHTML = `<div class="loading" style="color:red">Failed to load users.</div>`;
            }
        }

        // --- 3. Render List ---
        function renderUsers(users) {
            list.innerHTML = "";
            if(users.length === 0) {
                list.innerHTML = `<div class="loading">No other users found yet.<br>Invite friends to GX Studio!</div>`;
                return;
            }

            users.forEach(u => {
                let initial = u.name ? u.name.charAt(0).toUpperCase() : "U";
                
                let div = document.createElement('div');
                div.className = 'user-card';
                // Click karne par Chat Window khulegi (Query Param ke sath)
                div.onclick = () => {
                    window.location.href = `dm_window.html?uid=${u.uid}&name=${encodeURIComponent(u.name)}`;
                };

                div.innerHTML = `
                    <div class="avatar" style="background:${getColor(initial)}">${initial}</div>
                    <div class="user-info">
                        <div class="user-name">${u.name}</div>
                        <div class="user-email">${u.email}</div>
                    </div>
                    <i class="fas fa-chevron-right chat-icon"></i>
                `;
                list.appendChild(div);
            });
        }

        // --- 4. Search Filter ---
        window.filterUsers = function() {
            let q = document.getElementById('searchInput').value.toLowerCase();
            let filtered = allUser