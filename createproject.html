<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>New Project - Gothwad Studio</title>

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* SAME STYLE AS BEFORE */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-color); margin: 0; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding-bottom: 90px; overflow-x: hidden; }
        .header { margin-bottom: 25px; }
        .title { font-size: 24px; font-weight: 800; color: var(--primary); margin: 0; }
        .subtitle { font-size: 13px; color: var(--text-sub); margin-top: 5px; }
        .form-group { margin-bottom: 20px; width: 100%; }
        .label { font-size: 11px; font-weight: 700; color: var(--text-sub); margin-bottom: 8px; display: block; letter-spacing: 1px; text-transform: uppercase; }
        .std-input, .std-select { width: 100%; padding: 14px; background-color: var(--surface-color); border: 1px solid var(--border); border-radius: 10px; color: var(--text-main); font-size: 15px; outline: none; display: block; }
        .std-input:focus, .std-select:focus { border-color: var(--primary); }
        .select-wrapper { position: relative; width: 100%; }
        .select-wrapper::after { content: 'â–¼'; font-size: 10px; position: absolute; right: 15px; top: 18px; color: var(--text-sub); pointer-events: none; }
        .std-select { appearance: none; -webkit-appearance: none; }
        .std-input[readonly] { background-color: rgba(0,0,0,0.1); color: var(--text-sub); border-style: dashed; }
        .cloud-option { background: var(--surface-color); padding: 15px; border-radius: 12px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .cloud-text h4 { margin: 0; font-size: 14px; color: var(--text-main); }
        .cloud-text p { margin: 3px 0 0; font-size: 11px; color: var(--text-sub); }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .3s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }
        .bottom-actions { position: fixed; bottom: 0; left: 0; width: 100%; padding: 15px 20px; background: var(--surface-color); border-top: 1px solid var(--border); display: flex; gap: 15px; z-index: 50; }
        .btn-cancel { flex: 1; padding: 12px; background: transparent; border: 1px solid var(--border); color: var(--text-main); border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-create { flex: 2; padding: 12px; background: var(--primary); border: none; color: #fff; border-radius: 8px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div class="header">
    <h1 class="title">Create Project</h1>
    <div class="subtitle">Setup metadata & environment</div>
</div>

<div class="form-group">
    <label class="label">Project Name</label>
    <input type="text" id="p-name" class="std-input" placeholder="e.g. MyPortfolio" onkeyup="updatePackage()" autofocus>
</div>

<div class="form-group">
    <label class="label">Package ID (Auto-Generated)</label>
    <input type="text" id="p-pkg" class="std-input" value="com.gothwad.untitled" readonly>
</div>

<div class="form-group">
    <label class="label">Runtime Language</label>
    <div class="select-wrapper">
        <select id="p-lang" class="std-select">
            <option value="HTML">HTML5 / Web (Standard)</option>
            <option value="React">React Native</option>
            <option value="Kotlin">Kotlin (Android)</option>
            <option value="Python">Python 3</option>
        </select>
    </div>
</div>

<div class="form-group">
    <label class="label">UI Framework</label>
    <div class="select-wrapper">
        <select id="p-frame" class="std-select">
            <option value="none">Vanilla CSS (None)</option>
            <option value="bootstrap">Bootstrap 5</option>
            <option value="tailwind">Tailwind CSS</option>
        </select>
    </div>
</div>

<div class="form-group">
    <div class="cloud-option">
        <div class="cloud-text">
            <h4>Auto-Sync to Cloud</h4>
            <p>Backup code to Firebase automatically</p>
        </div>
        <label class="switch">
            <input type="checkbox" id="p-cloud" checked disabled>
            <span class="slider"></span>
        </label>
    </div>
</div>

<div class="form-group">
    <div class="cloud-option">
        <div class="cloud-text">
            <h4>Public Project</h4>
            <p id="vis-text">Only visible to you</p>
        </div>
        <label class="switch">
            <input type="checkbox" id="p-public" onchange="toggleVisText()">
            <span class="slider"></span>
        </label>
    </div>
</div>

<div class="bottom-actions">
    <button class="btn-cancel" onclick="history.back()">Cancel</button>
    <button class="btn-create" id="createBtn">Create Studio Project</button>
</div>

<script type="module">
    import { auth, db, collection, addDoc, serverTimestamp, onAuthStateChanged } from './firebase-config.js';

    let currentUser = null;

    let savedTheme = localStorage.getItem('gothwad_theme');
    if(savedTheme) document.body.classList.add(savedTheme);

    onAuthStateChanged(auth, (user) => {
        if(user) {
            currentUser = user;
        } else {
            alert("You must be logged in!");
            window.location.href = "login.html";
        }
    });

    window.updatePackage = () => {
        let name = document.getElementById('p-name').value;
        let pkgBox = document.getElementById('p-pkg');
        if(name.length > 0) {
            let safeName = name.toLowerCase().replace(/[^a-z0-9]/g, "");
            pkgBox.value = "com.gothwad." + safeName;
        } else {
            pkgBox.value = "com.gothwad.untitled";
        }
    }

    window.toggleVisText = () => {
        const isPublic = document.getElementById('p-public').checked;
        const txt = document.getElementById('vis-text');
        if(isPublic) {
            txt.innerText = "Project will be published in Explore";
            txt.style.color = "var(--primary)";
        } else {
            txt.innerText = "Only visible to you";
            txt.style.color = "var(--text-sub)";
        }
    }

    // --- MAIN FIX IS HERE ---
    document.getElementById('createBtn').addEventListener('click', async () => {
        const btn = document.getElementById('createBtn');
        const name = document.getElementById('p-name').value;
        const lang = document.getElementById('p-lang').value;
        const frame = document.getElementById('p-frame').value;
        const isPublic = document.getElementById('p-public').checked;

        if(!name) return alert("Please name your project!");
        if(!currentUser) return alert("Wait for login check...");

        btn.innerText = "Creating...";
        btn.disabled = true;

        let htmlCode = "<h1>Hello Gothwad!</h1>\n<p>Start editing...</p>";
        let cssCode = "body { font-family: sans-serif; padding: 20px; }";
        let jsCode = "console.log('App Started');";

        if(frame === 'bootstrap') {
            htmlCode = `<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">\n\n<div class="container mt-5">\n  <h1>Hello Bootstrap!</h1>\n  <button class="btn btn-primary">Click Me</button>\n</div>`;
        }

        // Data Object
        const projectData = {
            name: name,
            type: lang,
            framework: frame,
            isPublic: isPublic,
            packageId: document.getElementById('p-pkg').value,
            html: htmlCode,
            css: cssCode,
            js: jsCode,
            uid: currentUser.uid,
            author: currentUser.displayName || "Developer",
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
        };

        try {
            // STEP 1: Save to Personal 'projects' (For Home Page)
            // Ye zaroori hai taki aapke Home dashboard par dikhe
            const docRef = await addDoc(collection(db, "projects"), projectData);

            // STEP 2: IF PUBLIC -> Also Save to 'public_projects' (For Explore Page)
            // Ye zaroori hai taki Explore list me dikhe
            if (isPublic) {
                await addDoc(collection(db, "public_projects"), {
                    ...projectData,
                    originalId: docRef.id // Link to original project
                });
            }

            // Redirect
            window.location.href = "home.html";

        } catch (error) {
            console.error(error);
            alert("Error: " + error.message);
            btn.innerText = "Create Studio Project";
            btn.disabled = false;
        }
    });
</script>
</body>
</html>
