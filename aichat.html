<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Chat - Gothwad Studio</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- EXACT SAME DESIGN --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            display: flex; flex-direction: column; height: 100vh;
            background-color: var(--bg-color); 
            margin: 0; padding: 0;
            font-family: sans-serif;
            overflow: hidden;
        }

        /* HEADER */
        .chat-header {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background-color: var(--surface-color);
            padding: 0 15px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 100;
            border-bottom: 1px solid var(--border);
        }

        .header-left { display: flex; flex-direction: column; }
        .header-title { margin: 0; font-size: 18px; color: var(--text-main); font-weight: 800; }
        .ai-status { font-size: 11px; color: #00e676; display: flex; align-items: center; gap: 5px; font-weight: 500; }
        
        .header-right i { font-size: 18px; color: var(--text-sub); cursor: pointer; }

        /* CHAT AREA */
        .chat-area {
            flex: 1;
            margin-top: 60px;
            padding-bottom: 140px;
            padding-left: 10px; padding-right: 10px; padding-top: 15px;
            overflow-y: auto;
            display: flex; flex-direction: column; gap: 10px;
            scroll-behavior: smooth;
        }

        /* MESSAGES */
        .msg-row { display: flex; align-items: flex-end; gap: 8px; max-width: 85%; }
        
        .msg-bubble { 
            padding: 10px 14px; border-radius: 12px; 
            font-size: 14px; line-height: 1.5;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            position: relative;
        }

        .msg-row.user { align-self: flex-end; flex-direction: row-reverse; }
        .msg-row.user .msg-bubble { 
            background-color: var(--primary); color: #fff; 
            border-radius: 12px 0 12px 12px; 
        }

        .msg-row.ai { align-self: flex-start; }
        .msg-row.ai .msg-bubble { 
            background-color: var(--surface-color); color: var(--text-main); 
            border: 1px solid var(--border); 
            border-radius: 0 12px 12px 12px;
        }

        .msg-bubble pre {
            background: #1e1e1e; padding: 10px; border-radius: 6px;
            overflow-x: auto; font-family: monospace; margin: 8px 0;
            border: 1px solid #333; color: #a5d6ff; font-size: 12px;
        }
        .msg-bubble code {
            background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 3px;
            font-family: monospace; font-size: 12px;
        }
        .msg-bubble strong { color: var(--primary); }
        .error-msg { color: #ff4444 !important; font-weight: bold; }

        .typing-dots {
            font-size: 12px; color: var(--text-sub); font-style: italic;
            margin-left: 10px; margin-bottom: 10px; display: none;
        }

        .footer-container {
            position: fixed; bottom: 60px; left: 0; right: 0;
            background: var(--surface-color); z-index: 101;
            border-top: 1px solid var(--border);
            padding: 8px 10px;
            display: flex; align-items: center; gap: 10px;
            height: 60px;
        }

        .main-input {
            flex: 1; padding: 8px 15px; border-radius: 20px;
            border: 1px solid var(--border); background: var(--bg-color);
            color: var(--text-main); outline: none; font-size: 14px; height: 40px;
        }
        
        .send-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: var(--primary); color: #fff; border: none;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; cursor: pointer; flex-shrink: 0;
        }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
            background: var(--surface-color); display: flex; justify-content: space-around; 
            align-items: center; border-top: 1px solid var(--border); z-index: 100;
        }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-sub); text-decoration: none; height: 100%; }
        .nav-item i { font-size: 20px; margin-bottom: 4px; }
        .nav-item span { font-size: 10px; font-weight: 500; }
        .nav-item.active { color: var(--primary); }

    </style>
</head>
<body>

    <div class="chat-header">
        <div class="header-left">
            <h2 class="header-title">Gothwad AI</h2>
            <div class="ai-status">
                <i class="fas fa-bolt" style="color: #ffeb3b;"></i> Gemini 1.5 Flash
            </div>
        </div>
        <div class="header-right">
            <i class="fas fa-eraser" onclick="clearChat()"></i>
        </div>
    </div>

    <div class="chat-area" id="chatList">
        <div class="msg-row ai">
            <div class="msg-bubble">
                Hello! I am Gothwad AI (Gemini 1.5). Ask me anything!
            </div>
        </div>
    </div>

    <div class="typing-dots" id="typingInd">
        <i class="fas fa-circle-notch fa-spin"></i> Connecting...
    </div>

    <div class="footer-container">
        <input type="text" id="msgInput" class="main-input" placeholder="Ask AI...">
        <button class="send-btn" id="sendBtn"><i class="fas fa-paper-plane"></i></button>
    </div>

    <nav class="bottom-nav">
        <a href="home.html" class="nav-item"><i class="fas fa-home"></i><span>Home</span></a>
        <a href="explore.html" class="nav-item"><i class="fas fa-compass"></i><span>Explore</span></a>
        <a href="globalchat.html" class="nav-item"><i class="fas fa-users"></i><span>Global</span></a>
        <a href="chat.html" class="nav-item"><i class="fas fa-comment-dots"></i><span>DM</span></a>
        <a href="#" class="nav-item active"><i class="fas fa-robot"></i><span>AI</span></a>
    </nav>

    <script type="module">
        import { auth } from './firebase-config.js';

        const chatList = document.getElementById('chatList');
        const msgInput = document.getElementById('msgInput');
        const sendBtn = document.getElementById('sendBtn');
        const typingInd = document.getElementById('typingInd');

        // --- ‚ö° IMPORTANT: USE GEMINI 1.5 FLASH ‚ö° ---
        const API_KEY = "AIzaSyA0W-lAdT9BQhQzIiq67uBc1hmmSPKeULk"; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;

        auth.onAuthStateChanged((user) => {
            if (!user) window.location.href = 'login.html';
        });

        sendBtn.addEventListener('click', handleSend);
        msgInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleSend(); });

        async function handleSend() {
            const text = msgInput.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            msgInput.value = "";
            typingInd.style.display = 'block';
            scrollToBottom();

            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }]
                    })
                });

                const data = await response.json();
                typingInd.style.display = 'none';

                // --- ERROR HANDLING FOR KEY ISSUES ---
                if (data.error) {
                    console.error("Google API Error:", data.error);
                    
                    let errorMsg = `‚ùå API Error: ${data.error.message}`;
                    
                    // Specific advice if model is not found (Means Key is invalid for AI)
                    if(data.error.message.includes("not found")) {
                        errorMsg = `‚ùå <b>API Key Issue:</b> Your key doesn't support Gemini API.<br><br>üëâ Go to <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:#fff;text-decoration:underline;">Google AI Studio</a>, get a new key, and update it in the code.`;
                    }
                    
                    addMessage(errorMsg, 'ai', true);
                    return;
                }

                if (data.candidates && data.candidates[0].content) {
                    const rawText = data.candidates[0].content.parts[0].text;
                    const formattedText = formatAIResponse(rawText);
                    addMessage(formattedText, 'ai', true);
                } else {
                    addMessage("‚ö†Ô∏è AI sent an empty response.", 'ai');
                }

            } catch (error) {
                console.error(error);
                typingInd.style.display = 'none';
                addMessage(`‚ö†Ô∏è Network Error: ${error.message}`, 'ai');
            }
        }

        function addMessage(text, sender, isHTML = false) {
            const row = document.createElement('div');
            row.className = `msg-row ${sender}`;
            const bubble = document.createElement('div');
            bubble.className = 'msg-bubble';
            if(isHTML) bubble.innerHTML = text;
            else bubble.innerText = text;
            row.appendChild(bubble);
            chatList.appendChild(row);
            scrollToBottom();
        }

        function scrollToBottom() {
            chatList.scrollTop = chatList.scrollHeight;
        }

        function formatAIResponse(text) {
            let safeText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            return safeText
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
        }

        window.clearChat = function() {
            chatList.innerHTML = `<div class="msg-row ai"><div class="msg-bubble">Chat cleared.</div></div>`;
        }
    </script>
</body>
</html>